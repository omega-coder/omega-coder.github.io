<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>0m3g4K0d3r&#39;s Security Blog - 0m3g4K0d3r&#39;s Security Blog</title>
  <meta property="og:title" content="0m3g4K0d3r&#39;s Security Blog" />
  <meta name="twitter:title" content="0m3g4K0d3r&#39;s Security Blog" />
  <meta name="author" content="omega_coder"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "0m3g4K0d3r\x27s Security Blog",
    
    "url": "https:\/\/omega-coder.me"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/omega-coder.me"
  
  
  
  
}
</script>

<meta property="og:title" content="0m3g4K0d3r&#39;s Security Blog" />
<meta property="og:image" content="https://omega-coder.me/img/profile_pic.jpg" />
<meta property="og:url" content="https://omega-coder.me/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="0m3g4K0d3r&#39;s Security Blog" />
  <meta name="twitter:title" content="0m3g4K0d3r&#39;s Security Blog" />
  <meta name="twitter:image" content="https://omega-coder.me/img/profile_pic.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@yacine_cherief" />
  <meta name="twitter:creator" content="@yacine_cherief" />
  <link href='https://omega-coder.me/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://omega-coder.me/img/profile_pic.jpg" />
  <meta name="twitter:image" content="https://omega-coder.me/img/profile_pic.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@yacine_cherief" />
  <meta name="twitter:creator" content="@yacine_cherief" />
  <meta property="og:url" content="https://omega-coder.me/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="0m3g4K0d3r&#39;s Security Blog" />

  <meta name="generator" content="Hugo 0.55.4" />
  <link rel="alternate" href="https://omega-coder.me/index.xml" type="application/rss+xml" title="0m3g4K0d3r&#39;s Security Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://omega-coder.me/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://omega-coder.me/css/highlight.min.css" /><link rel="stylesheet" href="https://omega-coder.me/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-126655681-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://omega-coder.me">0m3g4K0d3r&#39;s Security Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="0m3g4K0d3r&#39;s Security Blog" href="https://omega-coder.me">
            <img class="avatar-img" src="https://omega-coder.me/img/profile_pic.jpg" alt="0m3g4K0d3r&#39;s Security Blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  
    <div id="header-big-imgs" data-num-img=4 
      
         
          data-img-src-1="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/b_rgb:000000,o_58/v1550264353/ComputerAsFuck.jpg" 
         
         data-img-desc-1="Q29tcHV0ZXJBc0Z1Y2sK"
      
         
          data-img-src-2="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/b_rgb:000000,o_64/v1550264352/Busted.jpg" 
         
         data-img-desc-2="QnVzdGVkCg=="
      
         
          data-img-src-3="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/b_rgb:000000,o_50/v1550263808/3395266-python-wallpapers.jpg" 
         
         data-img-desc-3="Q2hlc3MgaXMgbG92ZQo="
      
         
          data-img-src-4="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/b_rgb:000000,o_60/v1550264352/Hanging.jpg" 
         
         data-img-desc-4="SGFuZ2luZwo="
      ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="page-heading">
                <h1>Omega-coder&#39;s Blog</h1>
                  
                    
                      <hr class="small">
                      <span class="page-subheading">Just Another Security Oriented Blog.</span>
                    
                  
                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="page-heading">
              
                <h1>Omega-coder&#39;s Blog</h1>
              
              
                <hr class="small">
              
              
                
                  <span class="page-subheading">Just Another Security Oriented Blog.</span>
                
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
  <div role="main" class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        

        <div class="posts-list">
          
          
            <article class="post-preview">
              <a href="https://omega-coder.me/post/angstromctf-2019-secret-sheep-society-crypto-writeup/">
                <h2 class="post-title">AngstromCTF 2019 Secret Sheep Society Crypto 120 Writeup</h2>
                
                  <h3 class="post-subtitle">
                  AES CBC Mode bit-flipping attack
                  </h3>
                
                
              </a>

              <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on April 24, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;0&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;0&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;CHERIEF Yassine (omega-coder)
  
  
</span>


              <div class="post-entry">
                
                  

<h1 id="tl-dr">TL;DR</h1>

<ol>
<li>Spotting the weakness (AES with CBC Mode).</li>
<li>Get token</li>
<li>Flipping specific bytes in session json (turn <strong><code>flase</code></strong> to <strong><code>true</code></strong>).</li>
<li>manipulate token with flipped bytes.</li>
<li>Send manipulated token to page.</li>
<li>Get the flag.</li>
</ol>

<hr>

<h2 id="challenge-details">Challenge details</h2>

<table>
<thead>
<tr>
<th><strong>Category</strong></th>
<th><strong>Points</strong></th>
<th><strong>Solves</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>Crypto</td>
<td>120</td>
<td>98</td>
</tr>
</tbody>
</table>

<hr>

<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
<p>The sheep are up to no good. They have a <a href="https://secretsheepsociety.2019.chall.actf.co/">web portal</a> for their secret society, which we have the source for. It seems fairly easy to join the organization, but climbing up its ranks is a different story.<br> Author: defund</p>
</blockquote>

<h2 id="challenge-source">Challenge Source</h2>

<p>challenge app source can be found <a href="https://github.com/omega-coder/ctf-writeups/tree/master/AngstromCTF_2k19_Quals/Secret_Sheep_Society/app_source">here</a></p>

<hr>

<h2 id="what-the-app-is-doing">What the app is doing ?</h2>

<p>we have three important routes <code>/</code>, <code>/enter</code> and <code>/exit</code>.</p>

<ol>
<li><code>/</code> will show the flag if we have admin access.</li>
<li><code>/enter</code> accepts an input called <code>handle</code> and sets a cookie named <code>token</code> which is simply the base64 encoding of the <code>session</code> encryption using <code>AES</code> with <code>CBC</code> Mode and using Padding also.</li>
<li><code>/exit</code> will simply <strong>unset</strong> the <strong><code>token</code></strong> cookie.</li>
</ol>

<h2 id="what-we-know-vs-what-we-don-t">what we know VS. what we don&rsquo;t.</h2>

<hr>

<h4 id="we-know">We know :</h4>

<hr />

<ol>
<li>the format of the session which is : <code>{&quot;admin&quot;: false, &quot;handle&quot;: &quot;some_input_we_control&quot;}</code></li>
<li>encryption is using <code>AES_CBC</code> with <code>BLOCK_SIZE = 16</code>.</li>
<li>We have the ciphertext.
<br>
<hr></li>
</ol>

<h4 id="we-don-t-know">We don&rsquo;t know:</h4>

<ol>
<li>The Key.</li>
</ol>

<hr>

<p><strong><code>NOTE: I haven't used the browser for this task, i still don't know what the UI looks like!!</code></strong></p>

<p>let&rsquo;s see this piece of code:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/enter&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">enter</span><span class="p">():</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handle&#39;</span><span class="p">)</span>
	<span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
		<span class="s1">&#39;handle&#39;</span><span class="p">:</span> <span class="n">handle</span>
	<span class="p">}</span>
	<span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
	<span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="k">return</span> <span class="n">response</span></code></pre></div>
<p>To get a cookie we post to <code>/enter</code> with handle data parameter set to anything we want, after that the session variable gets set and passed to <code>manager.pack(session)</code> which will return a token base64 encoded.</p>

<p>Let&rsquo;s see now how does the pack method works. (.pack is defined in <code>manage.py file</code>).<br />
<strong>pack()</strong> takes a python dictionary as an argument and return a base64 encoded token.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Manager</span><span class="p">:</span>

	<span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

	<span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
		<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">)</span>
		<span class="n">iv</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">iv</span>
		<span class="n">dec</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
		<span class="n">enc</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_SIZE</span><span class="p">))</span>
		<span class="n">raw</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">enc</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span></code></pre></div>
<ol>
<li>creates a new AES cipher with CBC mode</li>
<li>get an IV</li>
<li>get string representation of the json object session.</li>
<li>pad data and encrypt it with <code>AES_CBC</code>.</li>
<li>return <code>base64(iv + enc)</code>.</li>
</ol>

<blockquote>
<p><strong><code>Note: iv is not encrypted, the IV is the first 16 bytes of the token found in cookie</code></strong></p>
</blockquote>

<p>Our string representation of the session json object is as follow:</p>

<p>This is the default json object string repr that we will have, provided that we enter <code>xx</code> as handle paramter. (Only an example).</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;admin&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nt">&#34;handle&#34;</span><span class="p">:</span> <span class="s2">&#34;xx&#34;</span><span class="p">}</span></code></pre></div>
<p>We obviously need to turn that <code>false</code> to <code>true&nbsp;</code>, since <code>false</code> is 5 bytes long and <code>true</code> is only 4 bytes long, we can replace <code>false</code> with <code>true&nbsp;</code> with an extra space at the end, that won&rsquo;t make a difference when parser by JSON.</p>

<p>if we provide handle with value <code>xx</code> then json string representation will be on exactly two blocks.
(<code>32 Bytes</code>).</p>

<p>The AES encryption will be 64 Bytes (4 Blocks of 16 bytes each), because IV is on 16 bytes, json string on 32 Bytes and padding on One block (16 Bytes)</p>

<blockquote>
<p>16 + 32 + 16 = 64</p>
</blockquote>

<pre><code>.................. = IV (IV is known to us)
{&quot;admin&quot;: false,   ==&gt; First Plaintext Block
 &quot;handle&quot;: &quot;xx&quot;}   ==&gt; Second Plaintext Block
\x10\x10\x10\x10 ... \x10 ==&gt; last padding block of size 16 

</code></pre>

<p>Now let&rsquo;s do bit-flipping and change the  <code>false</code> to <code>true&nbsp;</code>.</p>

<p>To understand the attack, we need to closely look how decryption takes place in this mode:</p>

<p><img src="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/v1556110161/601px-cbc_decryption-svg.png" alt="aes_cbc_decryption_scheme" /></p>

<p>Let&rsquo;s suppose our <code>{&quot;admin&quot;: false,</code> is our first block, this plaintext block is resulting from <code>XORing</code> the IV (Initialization Vector) with the first ciphertext block, as you can see from the figure above.We can manipulate the cookie returned by the server to forge a cookie that we decoded get json encoded to <code>{&quot;admin&quot;: true , &quot;handle&quot;: &quot;xx&quot;}</code>. A rule says that whenever you change one byte (&lsquo;flips&rsquo;) at an offset
in a given ciphertext block, the same offset is changed in the next plaintext block (see figure below)</p>

<p><img src="https://res.cloudinary.com/https-omega-coder-github-io/image/upload/v1556114028/082113_1459_cbcbyteflip3.jpg" alt="cbc_flip_byte" /></p>

<h2 id="fully-automated-exploit-with-python">Fully Automated Exploit with Python</h2>

<p>let&rsquo;s first try to get a token by posting handle data to <code>/enter</code></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;https://secretsheepsociety.2019.chall.actf.co/&#34;</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="c1"># generate token from /enter route </span>
<span class="n">token</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">enter_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;handle&#34;</span><span class="p">:</span> <span class="s2">&#34;xx&#34;</span><span class="p">}</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending &#39;xx&#39; as handle payload!&#34;</span><span class="p">)</span>
<span class="n">token_exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;token=(.*);&#39;</span><span class="p">)</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="o">+</span><span class="s2">&#34;enter&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enter_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;[?] Made request to /enter&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span><span class="p">:</span> <span class="c1"># means we are being redirected to / </span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[?] Got 302 Redirect request&#34;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">token_exp</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Set-Cookie&#34;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] Got token : &#34;</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span></code></pre></div>
<p>Now let&rsquo;s see the full script that will get a token from <code>/enter</code> and manipulate it and send it back to man route (index.html) to get the final flag.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;https://secretsheepsociety.2019.chall.actf.co/&#34;</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="c1"># generate token from /enter route </span>
<span class="n">token</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">enter_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;handle&#34;</span><span class="p">:</span> <span class="s2">&#34;xx&#34;</span><span class="p">}</span>
<span class="c1"># xx is just to make it 2 blocks in size</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending &#39;xx&#39; as handle payload!&#34;</span><span class="p">)</span>
<span class="n">token_exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;token=(.*);&#39;</span><span class="p">)</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="o">+</span><span class="s2">&#34;enter&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">enter_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># allow redirects is set to False because if set to True we won&#39;t be able to retrive</span>
<span class="c1"># the cookie set by /enter</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;[?] Made request to /enter&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span><span class="p">:</span> <span class="c1"># we are being redirected to /</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[?] Got 302 Redirect request&#34;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">token_exp</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Set-Cookie&#34;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] Got token : &#34;</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

<span class="c1"># &#39;f&#39; is located at offset 10 in the second block.</span>
<span class="c1"># &#39;a&#39; is located at offset 11 in the second block.</span>
<span class="c1"># &#39;l&#39; ....</span>
<span class="c1"># &#39;s&#39; ....</span>
<span class="c1"># &#39;e&#39; ....</span>
<span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">manipulated_token</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
    <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
    <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
    <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulated_token</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] Flipped Bytes 10, 11, 12, 13 and 14&#34;</span><span class="p">)</span>

    <span class="n">final_token</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">manipulated_token</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] generated new token &#34;</span><span class="p">,</span> <span class="n">final_token</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

<span class="k">if</span> <span class="n">final_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;token&#34;</span><span class="p">:</span> <span class="n">final_token</span><span class="o">.</span><span class="n">decode</span><span class="p">()}</span>
    
    <span class="c1"># if token is correct then session will contain {&#34;admin&#34;: True, &#34;handle&#34;: &#34;xx&#34;} </span>
    <span class="c1"># we will be able to get the flag</span>

    <span class="n">flag_exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;actf{.*}&#39;</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">flag_exp</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;[+] FLAG: &#34;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<p><code>FLAG = actf{shep_the_conqueror_slumbers}</code></p>

<p>Thanks for Reading.</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://omega-coder.me/tags/ctf/">ctf</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/crypto/">crypto</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/bit-flipping/">bit-flipping</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/aes/">aes</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/security/">security</a>&nbsp;
                  
                </div>
              
            </article>
          
            <article class="post-preview">
              <a href="https://omega-coder.me/post/hacklab-esgi-2019-rookie-web-writeup/">
                <h2 class="post-title">Hacklab ESGI 2019 |  Rookie Web100 Writeup</h2>
                
                  <h3 class="post-subtitle">
                  SSRF using gopher and curl
                  </h3>
                
                
              </a>

              <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on April 8, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;603&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;CHERIEF Yassine
  
  
</span>


              <div class="post-entry">
                
                  Challenge Description    Category Points Solves     web 100 18    
This is the URL for the challenge.
URL:http://ctf.hacklab-esgi.org:8082/
So, as soon as we visit the given URL, we get a simple web page saying Website Checker and the title saying super curling (this gonna be fun!!). we notice that there is one input in the page, whatever you give as input gets passed to curl as a parameter.
                  <a href="https://omega-coder.me/post/hacklab-esgi-2019-rookie-web-writeup/" class="post-read-more">[Read More]</a>
                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://omega-coder.me/tags/ctf/">ctf</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/writeup/">writeup</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/security/">security</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/web/">web</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/gopher/">gopher</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/exploit/">exploit</a>&nbsp;
                  
                </div>
              
            </article>
          
            <article class="post-preview">
              <a href="https://omega-coder.me/post/setup-ftp-and-ftps-server-on-archlinux-server/">
                <h2 class="post-title">Setup FTPS server on Archlinux</h2>
                
                  <h3 class="post-subtitle">
                  setting up Plain FTP and FTPS server
                  </h3>
                
                
              </a>

              <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on April 1, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;6&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1194&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;CHERIEF Yassine (omega-coder)
  
  
</span>


              <div class="post-entry">
                
                  History of FTP servers The original specification for the File Transfer Protocol was written by Abhay Bhushan and published as RFC 114 on 16 April 1971. Until 1980, FTP was still running on NCP (Network Control Program) the predecessor of TCP/IP, the protocol was later replaced by a TCP/IP version, RFC 765 (June 1980). On September 1998, RFC 2428 added IPv6 support and defined a new type of passive mode.
                  <a href="https://omega-coder.me/post/setup-ftp-and-ftps-server-on-archlinux-server/" class="post-read-more">[Read More]</a>
                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://omega-coder.me/tags/archlinux/">archlinux</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/ftp/">ftp</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/tutorial/">tutorial</a>&nbsp;
                  
                </div>
              
            </article>
          
            <article class="post-preview">
              <a href="https://omega-coder.me/post/securinets-ctf-2019-lost-flag-writeup/">
                <h2 class="post-title">Securinets CTF 2k19 Lost Flag Writeup</h2>
                
                  <h3 class="post-subtitle">
                  Exploiting VCS (Version Control System)
                  </h3>
                
                
              </a>

              <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on March 26, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;206&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;CHERIEF Yassine
  
  
</span>


              <div class="post-entry">
                
                  Description    Category Points Solves     Forensics 994 19    
Description : Help me get back my flag !
URL: https://web8.ctfsecurinets.com/
After visiting the link above, we get a login page.We can login using admin/admin, but unfortunately the flag is deleted.
Then I started searching in the website for any other infos, but with no success. the admin of the challenge (Tr'GFx) said that bruteforcing directories is enough to solve the challenge, so I used dirsearch.
                  <a href="https://omega-coder.me/post/securinets-ctf-2019-lost-flag-writeup/" class="post-read-more">[Read More]</a>
                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://omega-coder.me/tags/writeup/">writeup</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/ctf/">ctf</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/security/">security</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/securinets-ctf/">securinets-ctf</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/web/">web</a>&nbsp;
                  
                </div>
              
            </article>
          
            <article class="post-preview">
              <a href="https://omega-coder.me/post/streaming-server-using-nginx-and-nginx-rtmp-module/">
                <h2 class="post-title">Streaming server using NGINX and nginx-rtmp-module</h2>
                
                  <h3 class="post-subtitle">
                  Setting up HLS &#43; VoD streaming server
                  </h3>
                
                
              </a>

              <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on December 18, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;846&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;CHERIEF Yassine
  
  
</span>


              <div class="post-entry">
                
                  Introduction Most people who do streaming enjoy services like Twitch.tv in order to deliver video for viewers, which is a pretty good solution, but when it comes to having more control over your streams, or when you take in consideration the ability of people streaming to your server, or you want to stream to multiple places, or any other things that require having access to an actual RTMP stream from an RTMP server.
                  <a href="https://omega-coder.me/post/streaming-server-using-nginx-and-nginx-rtmp-module/" class="post-read-more">[Read More]</a>
                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://omega-coder.me/tags/nginx/">nginx</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/streaming/">streaming</a>&nbsp;
                  
                    <a href="https://omega-coder.me/tags/tutorial/">tutorial</a>&nbsp;
                  
                </div>
              
            </article>
          
        </div>

        
      </div>
    </div>
  </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:admin@omega-coder.me" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/yacinewebdz" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/omega-coder" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/yacine_cherief" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.instagram.com/omega_coder" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.youtube.com/channel/UCJ84GVWJlcEjLVckwgtH58g" title="Youtube">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://open.spotify.com/user/omega_coder" title="Spotify">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-spotify fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="https://omega-coder.me/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://omega-coder.me">omega_coder</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://omega-coder.me">0m3g4K0d3r&#39;s Security Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.55.4</a> powered &nbsp;&bull;&nbsp; Theme by Beautiful Hugo
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://omega-coder.me/js/main.js"></script>
<script src="https://omega-coder.me/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://omega-coder.me/js/load-photoswipe.js"></script>








<script type="text/javascript">
$(function(){
  $('#show-comments').on('click', function(){
    var disqus_shortname = 'omega-coder';
      
    (function() {
      var disqus = document.createElement('script'); 
      disqus.type = 'text/javascript'; 
      disqus.async = true;
      disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
    })();
      
    $(this).hide(); 
    });
  });
      
</script>
<script id="dsq-count-scr" src="//omega-coder.disqus.com/count.js" async></script>




  </body>
</html>

